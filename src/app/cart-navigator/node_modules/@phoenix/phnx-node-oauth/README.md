# Purpose

* This codebase has the codes for the node module to integrate with the Java based Spring OAuth
* It mocks what each resource does when it has to respond to a request

# Usage

* This is an express middleware, use it as one!
* Use this middleware, before registering any of your routes (Except for unprotected routes like /info).

```javascript
const oauth = require("phnx-node-oauth");

var app = Express();
app.use(oauth);

//Register your routes below here
```

### Prerequisites

> - You need to request for the public.cert file from the Phoenix Team. Just drop a [mail to us!](mailto:ird.phoenix@mu-sigma.com)
> - You need to register your **backend code as a resource** and **UI as a client** with the oauth. [Link](http://gitlab.ird.mu-sigma.com/muESP/phoenix-microservices/wikis/oauth-register)

### You need following object in your package.json of your server code

```javascript
"PhnxOAuth": {
    "cert": "./resources/public.cert", //path to the public.cert file
    "resourceID": "CONFIGURATIONANDDEPLOYMENT" //Resource id with which you registered as a resource with oauth
}
```

### From the UI code you need to do the following thing.

> - You need to get the identity token for the user

```
URL: https://dev.ird.mu-sigma.com/phoenix/authentication-service/login
METHOD: POST
HEADERS: {
  "content-type": "application/json"
},
BODY: {
  "userName" : "<USERNAME>"
  "password" : "<PASSWORD>"
}


Example Response:
{
  identity_token: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsiTVVGTE9XLVBIT0VOSVgiLCJMT0dHSU5HLVNFUlZJQ0UiLCJLRVlTVE9SRS1HRU5FUkFUT1IiLCJNVVJYLVNFUlZJQ0UiLCJBRE1JTi1TRVJWSUNFIiwiQURNSU4tU0VSVklDRS1DSElUUkFOU0hVIiwiTVVGTE9XLVNFUlZJQ0UtUEhPRU5JWCIsIkVOR0lORS1TRVJWSUNFIiwiUEhPRU5JWC1NQVJLRVRQTEFDRSJdLCJzY29wZSI6WyJyZWFkIiwid3JpdGUiXSwiZXhwIjoxNDg5NDYyMTIyLCJhdXRob3JpdGllcyI6WyJST0xFX0FETUlOIl0sImp0aSI6IjBmODRkNzdmLTBkYWItNDJmZi04ZTdiLWEyN2NjOTZkMTg0OCIsImNsaWVudF9pZCI6Ik1VUlgtU0VSVklDRSJ9.s9WglgRoUaPLsvoLbQXztUOfVCEyLmBe7UFGzk0lynWI7JxV6j5W6eYDFXvo6te-3s-lJx9dn2I9pXp4TF8v7AfHFCMrS3PhUF1AdsKzna8BxYXK52_6bkzAckhJHh6NP7b672DdBc5_aEbcXSnS7JvMT-wJ8dHIIuLmD_omZ-xvUMwOYSuoklSgpvvYtCNloAqRAA0xg8cjlHkqniCjYTQyWu_pjqjRATQUSXOg0cQ-m7PZczXHwy2wjlhZrxHoyJU"
}
```

> - You need to get the access token for the user for your application

```
URL: https://dev.ird.mu-sigma.com/phoenix/authentication-service/authorize
METHOD: POST
HEADERS: {
  "content-type": "application/json",
  "identity_token": "Bearer <identity_token from previous request>"
},
BODY: {
  "clientId" : "<CLIENT_ID>" //Client id with which you registered your UI as a client in the oauth
  "clientSecret" : "" //Usually it is empty,
  "grantType" : "client_credentials"
}


Example Response:
{
  access_token: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOlsiTVVGTE9XLVBIT0VOSVgiLCJMT0dHSU5HLVNFUlZJQ0UiLCJLRVlTVE9SRS1HRU5FUkFUT1IiLCJNVVJYLVNFUlZJQ0UiLCJBRE1JTi1TRVJWSUNFIiwiQURNSU4tU0VSVklDRS1DSElUUkFOU0hVIiwiTVVGTE9XLVNFUlZJQ0UtUEhPRU5JWCIsIkVOR0lORS1TRVJWSUNFIiwiUEhPRU5JWC1NQVJLRVRQTEFDRSJdLCJzYwZSI6WyJyZWFkIiwid3JpdGUiXSwiZXhwIjoxNDg5NDYyMTIyLCJhdXRob3JpdGllcyI6WyJST0xFX0FETUlOIl0sImp0aSI6IjBmODRkNzdmLTBkYWItNDJmZi04ZTdiLWEyN2NjOTZkMTg0OCIsImNsaWVudF9pZCI6Ik1VUlgtU0VSVklDRSJ9.s9WglgRoUaPLsvoLbQXztUOfVCEyLmBe7UFGzk0lynWI7JxV6j5W6eYDFXvo6te-3s-lJx9dn2I9pXp4TF8v7AfHFCMrS3PhUF1AdsKzna8BxYXK52_6bkzAckhJHh6NP7b672DdBc5_aEbcXSnS7JvMT-wJ8dHIIuLmD_omZ-xvUMwOYSuoklSgpvvYtCNloAqRAA0xg8cjlHkqniCjYTQyWu_pjqjRATQUSXOg0cQ-m7PZczXHwy2wjlhZrxHoyJUE4k4iZktVuhbJ56d3-IkFVDK7ubnfEmr9TIGZ62yA2afmYjCtntth1wCJ9VdM_8mPA2PhYi4PcUUctkgjgw"
}
```

> **With every subsequent request you need to send the access token that you get in the "authorization" header**

```
HEADERS: {
  "authorization": "Bearer <access_token>"
}
```


### It's also suggested to use the Phoenix Eureka server