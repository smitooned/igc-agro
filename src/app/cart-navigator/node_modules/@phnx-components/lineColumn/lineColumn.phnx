/*
 *   Author: Debashish Pradhan
 *   Date Created : 3rd July
 *   Description: This is a line Column combo-chart with configurable options exposed and is an integral part of graphs in reusable components
 */

'use strict';

//noinspection JSUnresolvedVariable
module.exports = {
    name: "LineColumn",
    imports: [
        {
            type: "module",
            from: "d3",
            take: {
                what: "*",
                as: "d3"
            }
        }, {
            type: 'css',
            from: './lineColumn.css'
        }, {
            type: "asset",
            from: "./assets/data.json",
            take: "lineColumn"
        }

    ],
    variables: [
        {
            name: "alias",
            type: "string",
            defaultValue: "Line Column",
            metadata: [{
                displayName: "Alias",
                widget: "INPUT",
                widgetData: {},
                grouping: "General",
                target: "alias"
            }],
            isMandatory: false,
            scope: "public"

        },
        {
            name: "compStyle",
            defaultValue: {
                __root: {
                    backgroundColor: "rgba(255,255,255,1)",
                    borderWidth: "1px",
                    borderStyle: {
                        text: "Solid",
                        className: "fa fa-trash",
                        id: "solid"
                    },
                    borderColor: "rgba(0,0,0,0.12)",
                    borderRadius: 0,
                    height: 400,
                    width: 750
                }
            },
            type: "object",
            scope: "public",
            metadata: [
                {
                    displayName: 'LineColumn Chart',
                    widget: 'CHART_PROPERTIES',
                    widgetData: {},
                    grouping: '',
                    tab: 'Style',
                    target: 'compStyle.__root'
                },
                {
                    displayName: "Width",
                    widget: "NUMERIC_STEPPER",
                    widgetData: {},
                    grouping: "General",
                    target: "compStyle.__root.width"
                },
                {
                    displayName: "Height",
                    widget: "NUMERIC_STEPPER",
                    widgetData: {},
                    grouping: "General",
                    target: "compStyle.__root.height"
                },
                {
                    displayName: "Background color",
                    widget: "COLOR_PICKER",
                    widgetData: {},
                    grouping: "General",
                    target: "compStyle.__root.backgroundColor"
                }, {
                    displayName: "Border Width",
                    widget: "NUMERIC_STEPPER",
                    widgetData: {
                        minValue: 0
                    },
                    grouping: "Style",
                    target: "compStyle.__root.borderWidth"
                }, {
                    displayName: "Border Style",
                    widget: "DROPDOWN",
                    widgetData: {
                        values: [
                            {
                                text: "None",
                                className: "fa fa-trash",
                                id: "none"
                            },
                            {
                                text: "Solid",
                                className: "fa fa-trash",
                                id: "solid"
                            },
                            {
                                text: "Dotted",
                                className: "fa fa-trash",
                                id: "dotted"
                            },
                            {
                                text: "Dashed",
                                className: "fa fa-trash",
                                id: "dashed"
                            },
                            {
                                text: "Double",
                                className: "fa fa-trash",
                                id: "double"
                            }

                        ]
                    },
                    grouping: "Style",
                    target: "compStyle.__root.borderStyle"
                }, {
                    displayName: "Border Color",
                    widget: "COLOR_PICKER",
                    widgetData: {},
                    grouping: "Style",
                    target: "compStyle.__root.borderColor"
                }, {
                    displayName: "Border Radius",
                    widget: "NUMERIC_STEPPER",
                    widgetData: {
                        minValue: 0
                    },
                    grouping: "Style",
                    target: "compStyle.__root.borderRadius"
                }
            ]

        },
        {
            name: "title",
            type: "object",
            defaultValue: {
                text: "Line Column",
                color: "rgba(0,0,0,0.7)",
                fontSize: "20px",
                fontFamily: "Roboto",
                transform: "none"
            },
            metadata: [{
                displayName: 'Text',
                widget: 'CHART_TEXT_PROPERTIES',
                widgetData: {
                    showHeader: 'showHeader'
                },
                grouping: '',
                tab: 'Text',
                target: 'title'
            }, {
                displayName: "Text",
                widget: "INPUT",
                widgetData: {},
                grouping: "Title",
                target: "title.text"
            }, {
                displayName: "Color",
                widget: "COLOR_PICKER",
                widgetData: {},
                grouping: "Title",
                target: "title.color"
            }, {
                displayName: "Font Size",
                widget: "NUMERIC_STEPPER",
                widgetData: {},
                grouping: "Title",
                target: "title.fontSize"
            }, {
                displayName: "Font Family",
                widget: "FONT_SELECTOR",
                widgetData: {},
                grouping: "Title",
                target: "title.fontFamily"
            }, {
                displayName: "Case",
                widget: "TEXT_TRANSFORMER",
                widgetData: {},
                grouping: "Title",
                target: "title.transform"
            }],
            scope: "public"
        },
        {
            name: "colorTheme",
            type: "object",
            defaultValue: {
                scheme: "Default",
                colors: ["#3ec4cd", "#3d9fcc", "#3d7ccc", "#3e41cc", "#693ecc", "#963dcd", "#a1cc3e", "#3ccc86"]
            },
            scope: "public"

        },
        {
            name: "compTheme",
            type: "object",
            defaultValue: null,
            metadata: [{
                displayName: "Color theme",
                widget: "COLOR_PALETTE",
                widgetData: {},
                grouping: "Style",
                target: "compTheme"
            }],
            scope: "public"
        },
        {
            name: "xAxisticksOrientation",
            type: "boolean",
            defaultValue: false,
            metadata: [{
                displayName: "Rotate X Axis Ticks",
                widget: "SWITCHERY",
                widgetData: {},
                grouping: "Advanced",
                target: "xAxisticksOrientation"
            }],
            scope: "public"

        },
        {
            name: "yAxisticksOrientation",
            type: "boolean",
            defaultValue: false,
            metadata: [{
                displayName: "Rotate Y Axis Ticks",
                widget: "SWITCHERY",
                widgetData: {},
                grouping: "Advanced",
                target: "yAxisticksOrientation"
            }],
            scope: "public"

        },
        {
            name: "yAxisRange",
            type: "boolean",
            defaultValue: true,
            metadata: [{
                displayName: "Y Axis Range(0 to max)",
                widget: "SWITCHERY",
                widgetData: {},
                grouping: "Advanced",
                target: "yAxisRange"
            }],
            scope: "public"
        },
        {
            name: "compData",
            type: "object",
            defaultValue: {
                selectedDataset: "Default",
                parsedData: "__imports__lineColumn"
            },
            metadata: [{
                displayName: 'LineColumn Chart',
                widget: 'CHART_DATA_PROPERTIES',
                widgetData: {
                    axisTarget: ['compMetadata.xAxisVariable', 'compMetadata.yAxisVariable', 'compMetadata.zAxisVariable'],
                    xAxisLabel: 'axisLabel.xAxisLabel',
                    yAxisLabel: 'axisLabel.yAxisLabel',
                    axisColor: 'axisLabel.axisColor'
                },
                grouping: '',
                tab: 'Data',
                target: 'compData'
            }, {
                displayName: "Data Source",
                widget: "DATASOURCE",
                widgetData: {},
                grouping: "Data",
                target: "compData"
            }],
            isMandatory: false,
            scope: "public"
        },
        {
            name: "compMetadata",
            type: "object",
            defaultValue: {
                xAxisVariable: ["letter"],
                yAxisVariable: ["frequency", "frequency2"],
                zAxisVariable: ["frequency2"]
            },
            metadata: [{
                    displayName: "X-Axis Key",
                    widget: "ARRAY_INPUT",
                    widgetData: {
                        enableSuggestions: true,
                        placeHolder: "Add key",
                        minTagLength: 0
                    },
                    grouping: "Data",
                    target: "compMetadata.xAxisVariable"
            }, {
                    displayName: "Y-Axis Key",
                    widget: "ARRAY_INPUT",
                    widgetData: {
                        enableSuggestions: true,
                        placeHolder: "Add key",
                        minTagLength: 0
                    },
                    grouping: "Data",
                    target: "compMetadata.yAxisVariable"
            },
                {
                    displayName: "Z-Axis Key",
                    widget: "ARRAY_INPUT",
                    widgetData: {
                        enableSuggestions: true,
                        placeHolder: "Add key",
                        minTagLength: 0
                    },
                    grouping: "Data",
                    target: "compMetadata.zAxisVariable"
                }],
            isMandatory: false,
            scope: "public"
        },
        {
            name: "curveType",
            type: "object",
            defaultValue: {
                text: "Linear Curve",
                className: "fa fa-trash",
                id: "curveLinear"
            },
            metadata: [{
                displayName: "Curve Type",
                widget: "DROPDOWN",
                widgetData: {
                    values: [
                        {
                            text: "Cardinal Curve",
                            className: "fa fa-trash",
                            id: "curveCardinal"
                        },
                        {
                            text: "Linear Curve",
                            className: "fa fa-trash",
                            id: "curveLinear"
                        },
                        {
                            text: "Step Before Curve",
                            className: "fa fa-trash",
                            id: "curveStepBefore"
                        },
                        {
                            text: "Step After Curve",
                            className: "fa fa-trash",
                            id: "curveStepAfter"
                        },
                        {
                            text: "Basis Curve",
                            className: "fa fa-trash",
                            id: "curveBasis"
                        },
                        {
                            text: "Step Curve",
                            className: "fa fa-trash",
                            id: "curveStep"
                        }]
                },
                grouping: "General",
                target: "curveType"
            }],
            scope: "public"
        },
        {
            name: "advancedProps",
            type: "boolean",
            defaultValue: '',
            metadata: [{
                displayName: "Advanced",
                widget: "CHART_ADVANCED_PROPERTIES",
                widgetData: {
                    xAxisticksOrientation: 'xAxisticksOrientation',
                    yAxisticksOrientation: 'yAxisticksOrientation',
                    yAxisRange: 'yAxisRange',
                    area: 'area',
                    showLegend: 'showLegend',
                    showGrid: 'showGrid',
                    gridColor: 'gridColor',
                    curveType: 'curveType'
                },
                grouping: "",
                tab: 'Advanced',
                target: "advancedProps"
            }],
            scope: "public"
        },
        {
            name: "axisLabel",
            type: "object",
            defaultValue: {
                xAxisLabel: "Letter",
                yAxisLabel: "Frequency",
                axisColor: "rgba(0,0,0,1)"
            },
            metadata: [{
                displayName: "xAxis Label",
                widget: "INPUT",
                widgetData: {},
                grouping: "Data",
                target: "axisLabel.xAxisLabel"
            }, {
                displayName: "yAxis Label",
                widget: "INPUT",
                widgetData: {},
                grouping: "Data",
                target: "axisLabel.yAxisLabel"
            }, {
                displayName: "Axis Color",
                widget: "COLOR_PICKER",
                widgetData: {},
                grouping: "Data",
                target: "axisLabel.axisColor"
            }],
            scope: "public"
        },
        {
            name: "axisFormat",
            type: "object",
            defaultValue: {
                xAxisFormat: {
                    text: "String",
                    className: "fa fa-trash",
                    id: "scaleBand"
                },
                yAxisFormat: {
                    text: "Number",
                    className: "fa fa-trash",
                    id: "scaleLinear"
                },

            },
            metadata: [{
                    displayName: "X Axis Format",
                    widget: "DROPDOWN",
                    widgetData: {
                        values: [
                            {
                                text: "Number",
                                className: "fa fa-trash",
                                id: "scaleLinear"
                        },
                            {
                                text: "String",
                                className: "fa fa-trash",
                                id: "scaleBand"
                        }
                    ]
                    },
                    grouping: "Data",
                    target: "axisFormat.xAxisFormat"
            },
                {
                    displayName: "Y Axis Format",
                    widget: "DROPDOWN",
                    widgetData: {
                        values: [
                            {
                                text: "Number",
                                className: "fa fa-trash",
                                id: "scaleLinear"
                            },
                            {
                                text: "String",
                                className: "fa fa-trash",
                                id: "scaleBand"
                            }
                        ]
                    },
                    grouping: "Data",
                    target: "axisFormat.yAxisFormat"
                }],
            scope: "public"

        },
        {
            name: "showHeader",
            type: "boolean",
            defaultValue: true,
            metadata: [{
                displayName: "Show Title",
                widget: "SWITCHERY",
                widgetData: {},
                grouping: "General",
                target: "showHeader"
            }],
            scope: "public"
        },
        {
            name: "gridColor",
            type: "string",
            defaultValue: "rgba(200,200,200,0.8)",
            metadata: [{
                displayName: "Grid Color",
                widget: "COLOR_PICKER",
                widgetData: {},
                grouping: "Advanced",
                target: "gridColor"
            }],
            scope: "public"
        },
        {
            name: "showLegend",
            type: "boolean",
            defaultValue: true,
            metadata: [{
                displayName: "Show Legend",
                widget: "SWITCHERY",
                widgetData: {},
                grouping: "Advanced",
                target: "showLegend"
            }],
            scope: "public"
        },
        {
            name: "showGrid",
            type: "boolean",
            defaultValue: true,
            metadata: [{
                displayName: "Show Grid",
                widget: "SWITCHERY",
                widgetData: {},
                grouping: "Advanced",
                target: "showGrid"
            }],
            scope: "public"
        },
        {
            name: "margin",
            type: "object",
            defaultValue: {
                top: 20,
                right: 55,
                bottom: 30,
                left: 50
            },
            scope: "private"
        },
        {
            name: 'elementId',
            type: 'string',
            defaultValue: '',
            scope: 'private'
        }

    ],
    eventEmitters: [],
    eventHandlers: [],
    functions: {
        customRender: function () {

            d3.select(__elId__lineColumnComp).selectAll("*").remove();

            let padding = 20;

            let svg = d3.select(__elId__lineColumnComp),
                width = __var__compStyle.__root.width - __var__margin.left - __var__margin.right - 25;

            if (__var__showHeader) {
                var height = __var__compStyle.__root.height - (__var__margin.top * 3) - __var__margin.bottom - 25,
                    g = svg.append("g").attr("transform", "translate(" + (__var__margin.left + padding) + "," + ((__var__margin.top * 3) - 10) + ")");
            } else {
                height = __var__compStyle.__root.height - __var__margin.top - __var__margin.bottom - 25,
                    g = svg.append("g").attr("transform", "translate(" + (__var__margin.left + padding) + "," + (__var__margin.top / 2) + ")");
            }


            let axisFormat = {
                scaleLinear: d3.scaleLinear,
                scaleBand: d3.scaleBand
            }

            let curveType = {
                curveLinear: d3.curveLinear,
                curveCardinal: d3.curveCardinal,
                curveBasis: d3.curveBasis,
                curveStepBefore: d3.curveStepBefore,
                curveStepAfter: d3.curveStepAfter,
                curveStep: d3.curveStep
            };

            try {
                let x = axisFormat[__var__axisFormat.xAxisFormat.id]().rangeRound([0, width]).padding(0.1),
                    x0 = axisFormat[__var__axisFormat.xAxisFormat.id]().rangeRound([0, width]).padding(0.1),
                    y = axisFormat[__var__axisFormat.yAxisFormat.id]().rangeRound([height, 0]);


                x.domain(__var__compData.parsedData.map(function (d) {
                    return d[__var__compMetadata.xAxisVariable];
                }));

                x0.domain(__var__compMetadata.yAxisVariable).rangeRound([0, x.bandwidth()]);
                if (__var__yAxisRange) {
                    y.domain([0, d3.max(__var__compData.parsedData, function (d) {
                        return d3.max(__var__compMetadata.yAxisVariable, function (key) { return +d[key]; });
                    })]);
                } else {
                    y.domain(d3.extent(__var__compData.parsedData, function (d) {
                        return d3.max(__var__dataKeys, function (key) { return +d[key]; });
                    }));
                }


                let color = d3.scaleOrdinal(__var__compTheme ? __var__compTheme.colors : (__var__colorTheme.colors ? __var__colorTheme.colors : ["#3ec4cd", "#3d9fcc", "#3d7ccc", "#3e41cc", "#693ecc", "#963dcd", "#a1cc3e", "#3ccc86"]));

                // gridlines in x axis
                let make_x_gridlines = function () {
                    return d3.axisBottom(x)
                        .ticks(2);
                };

                // gridlines in y axis
                let make_y_gridlines = function () {
                    return d3.axisLeft(y)
                        .ticks(Math.round(height / 70));
                };
                let formatPercent = d3.format(".0%");

                let xAxis = d3.axisBottom()
                    .scale(x);

                console.log("xAxis", xAxis);

                let yAxis = d3.axisLeft()
                    .scale(y).ticks(Math.round(height / 50));

                let zdataArray = [__var__compMetadata.zAxisVariable];

                let dataArray = __var__compMetadata.yAxisVariable.concat(zdataArray);

                let line = d3.line()
                    .curve(curveType[__var__curveType.id])
                    .x(function (d) {
                        return x(d[__var__compMetadata.xAxisVariable]) + x.bandwidth() / 2;
                    })
                    .y(function (d) {
                        return y(d[__var__compMetadata.zAxisVariable]);
                    });


                g.append("g")
                    .attr("class", "axis-x")
                    .attr("id", __var__elementId)
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis)
                    .append("text")
                    .attr("transform", "translate(" + (width / 2) + " ," + (__var__margin.bottom * 2) + ")")
                    .style("text-anchor", "middle")
                    .style("font-size", "14px")
                    .text(__var__axisLabel.xAxisLabel);

                g.append("g")
                    .attr("class", "axis-y")
                    .attr("id", __var__elementId)
                    .call(yAxis)
                    .append("text")
                    .attr("transform", "translate(" + (-__var__margin.right) + " ," + (height / 2) + ") rotate(-90)")
                    .style("text-anchor", "middle")
                    .style("font-size", "14px")
                    .text(__var__axisLabel.yAxisLabel);

                d3.selectAll("#" + __var__elementId + ".axis-y line").attr("stroke", __var__axisLabel.axisColor);
                d3.selectAll("#" + __var__elementId + ".axis-y path").attr("stroke", __var__axisLabel.axisColor);
                d3.selectAll("#" + __var__elementId + ".axis-y text").attr("fill", __var__axisLabel.axisColor);
                if (__var__yAxisticksOrientation) {
                    d3.selectAll("#" + __var__elementId + ".axis-y .tick text").style("text-anchor", "end").attr("dy", "-.8em").attr("dx", ".15em").attr("transform", "rotate(-50)").style("font-size", "10px");
                }

                d3.selectAll("#" + __var__elementId + ".axis-x line").attr("stroke", __var__axisLabel.axisColor);
                d3.selectAll("#" + __var__elementId + ".axis-x path").attr("stroke", __var__axisLabel.axisColor);
                d3.selectAll("#" + __var__elementId + ".axis-x text").attr("fill", __var__axisLabel.axisColor);
                if (__var__xAxisticksOrientation) {
                    d3.selectAll("#" + __var__elementId + ".axis-x .tick text").style("text-anchor", "end").attr("dx", "-.6em").attr("dy", ".15em").attr("transform", "rotate(-25)").style("font-size", "10px");
                }
                // add the gridlines
                if (__var__showGrid) {
                    // g.append("g")
                    //     .attr("class", "grid")
                    //     .attr("transform", "translate(0," + height + ")")
                    //     .call(make_x_gridlines()
                    //         .tickSize(-height)
                    //         .tickFormat("")
                    //     );

                    g.append("g")
                        .attr("class", "grid")
                        .call(make_y_gridlines()
                            .tickSize(-width)
                            .tickFormat("")
                        );

                    d3.selectAll(".grid").selectAll("line")
                        .style("stroke", __var__gridColor);
                }

                if (__var__showHeader) {
                    let h = svg.append("g").attr("transform", "translate(" + __var__margin.left + "," + __var__margin.top + ")");

                    h.append("line")
                        .attr("x1", 0 - (__var__margin.left))
                        .attr("y1", __var__margin.top)
                        .attr("x2", width + __var__margin.left + 30)
                        .attr("y2", __var__margin.top)
                        .style("stroke", "rgba(0,0,0,0.12)");

                    h.append('text')
                        .text(__var__title.text)
                        .attr("fill", __var__title.color)
                        .attr('x', 0)
                        .attr('y', __var__margin.top - 10)
                        .attr('text-anchor', "start")
                        .style('font-family', __var__title.fontFamily)
                        .style("font-size", __var__title.fontSize)
                        .style("text-decoration", "none")
                        .style("text-transform", __var__title.transform);

                }




                g.append("g")
                    .selectAll("g")
                    .data(__var__compData.parsedData)
                    .enter().append("g").attr("transform", function (d) { return "translate(" + x(d[__var__compMetadata.xAxisVariable]) + ",0)"; })
                    .selectAll("rect")
                    .data(function (d) { return __var__compMetadata.yAxisVariable.map(function (key) { return { key: key, value: d[key] }; }); })
                    .enter().append("rect")
                    .attr("x", function (d) {
                        return x0(d.key);
                    })
                    .attr("y", function (d) {
                        return y(d.value);
                    })
                    .attr("width", x0.bandwidth())
                    .attr("height", function (d) {
                        return height - y(d.value);
                    })
                    .attr("fill", function (d) { return color(d.key); });
                // .on("mousemove", function() {
                //     d3.event.currentTarget.attributes.fill.nodeValue = __var__compStyle.__root.hoverColor;
                // })
                // .on("mouseout", function() {
                //     d3.event.currentTarget.attributes.fill.nodeValue = __var__compTheme? __var__compTheme.colors: (__var__colorTheme.colors?__var__colorTheme.colors:["#3ec4cd","#3d9fcc","#3d7ccc","#3e41cc","#693ecc","#963dcd","#a1cc3e","#3ccc86"]);
                // });

                g.append("path")
                    .attr("fill", "none")
                    .attr("stroke", color(0))
                    .attr("stroke-width", 2)
                    .attr("d", line(__var__compData.parsedData));

                if (__var__showLegend) {
                    let legend = g.selectAll(".legend")
                        .data(color.domain())
                        .enter().append("g")
                        .attr("class", "legend")
                        .attr("transform", function (d, i) {
                            return "translate(0," + i * 20 + ")";
                        });

                    legend.append("rect")
                        .attr("x", width + 30)
                        .attr("y", 0)
                        .attr("width", 15)
                        .attr("height", 15)
                        .style("fill", color);

                    legend.append("text")
                        .attr("x", width + 20)
                        .attr("y", 8)
                        .attr("dy", ".35em")
                        .attr("fill", __var__axisLabel.axisColor)
                        .style("text-anchor", "end")
                        .text(function (d, i) {
                            return dataArray[i];
                        });
                }


            } catch (err) {
                let h = svg.append("g").attr("transform", "translate(" + __var__margin.left + "," + __var__margin.top + ")");


                h.append('text')
                    .text("Oops!")
                    .attr("fill", __var__axisLabel.axisColor)
                    .attr('x', width / 2)
                    .attr('y', height / 3)
                    .attr('text-anchor', "middle")
                    .style('font-family', "Roboto")
                    .style("font-size", "20px")
                    .style("text-decoration", "none")
                    .style("text-transform", "none");


                h.append('text')
                    .text("Select a proper data format!")
                    .attr("fill", __var__axisLabel.axisColor)
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', "middle")
                    .style('font-family', "Roboto")
                    .style("font-size", "14px")
                    .style("text-decoration", "none")
                    .style("text-transform", "none");
            }

        }
    },

    structure: {
        type: "div",
        id: "lineColumnParent",
        props: {
            style: {
                backgroundColor: "__var__compStyle.__root.backgroundColor",
                width: "__var__compStyle.__root.width",
                height: "__var__compStyle.__root.height"
            }
        },
        children: [
            {
                type: "svg",
                id: "lineColumnComp",
                props: {
                    viewBox: "'0 0 '+__var__compStyle.__root.width+ ' '+__var__compStyle.__root.height",
                    width: "__var__compStyle.__root.width",
                    height: "__var__compStyle.__root.height",
                    style: {
                        borderWidth: "__var__compStyle.__root.borderWidth",
                        borderStyle: "__var__compStyle.__root.borderStyle.id",
                        borderColor: "__var__compStyle.__root.borderColor",
                        borderRadius: "__var__compStyle.__root.borderRadius"
                    }

                }

            }

        ]
    },
    lifecycleHooks: {
        init: {
            before: function () {
                __utils__setPrivateVars({ elementId: __prop__id }, false, { concat: false, erase: true });
            },
            after: function () {
                __fn__customRender();
            }
        },
        onModelChange: function (newExternalVarialbes) {

        },
        reRender: {
            shouldAllow: function (newExternalVariables) {
                return true;
            },
            before: function (newExternalVariables) {

            },
            after: function (newExternalVariables) {
                __fn__customRender();
            }
        },
        cleanup: function () {}
    }
};