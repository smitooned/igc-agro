/**
 * Slicer Form Component
 * Modifed
 * Project: Phoenix UI creator
 * Author: Debashish
 */


"use strict";

module.exports = {
    name: "slicer",
    imports: [
        {
            type: "module",
            from: "d3",
            take: {
                what: "*",
                as: "d3"
            }
        }
    ],
    variables: [{
        name: "alias",
        type: "string",
        defaultValue: "Slicer",
        metadata: [{
            displayName: "Alias",
            widget: "INPUT",
            widgetData: {},
            grouping: "General",
            target: "alias"
        }],
        isMandatory: false,
        scope: "public"

    },
        {
            name: "compStyle",
            type: "object",
            defaultValue: {
                __root: {
                    "width": 300,
                    "height": 30,
                    "stroke": "rgba(0,0,0,0.3)",
                    "strokeWidth": 10,
                    "handleColor": "rgba(24,149, 168, 1)",
                    "fill": "rgba(255,0,0,0.3)",
                    "handleThickness": 10,
                    "initialValue": 26,
                    "finalValue": 70
                }
            },
            metadata: [{
                displayName: 'Slicer',
                widget: 'SLIDER_PROPERTIES',
                widgetData: {},
                grouping: '',
                tab: 'Style',
                target: 'compStyle.__root'
            },{
                displayName: "Width",
                widget: "NUMERIC_STEPPER",
                widgetData: {},
                grouping: "General",
                target: "compStyle.__root.width"
            },
                {
                    displayName: "Height",
                    widget: "NUMERIC_STEPPER",
                    widgetData: {},
                    grouping: "General",
                    target: "compStyle.__root.height"
                },
                {
                    displayName: "Color",
                    widget: "COLOR_PICKER",
                    widgetData: {},
                    grouping: "Bar",
                    target: "compStyle.__root.stroke"
                },
                {
                    displayName: "Thickness",
                    widget: "NUMERIC_STEPPER",
                    widgetData: {},
                    grouping: "Bar",
                    target: "compStyle.__root.strokeWidth"
                },
                {
                    displayName: "Handle Color",
                    widget: "COLOR_PICKER",
                    widgetData: {},
                    grouping: "Range Slider",
                    target: "compStyle.__root.handleColor"
                },
                {
                    displayName: "Fill Color",
                    widget: "COLOR_PICKER",
                    widgetData: {},
                    grouping: "Bar",
                    target: "compStyle.__root.fill"
                },
                {
                    displayName: "Thickness",
                    widget: "NUMERIC_STEPPER",
                    widgetData: {},
                    grouping: "Range Slider",
                    target: "compStyle.__root.handleThickness"
                },
                {
                    displayName: "Initial Value",
                    widget: "SLIDER",
                    widgetData: {
                        minValue: 0,
                        maxValue: 100,
                        stepCount: 1
                    },
                    grouping: "Range Slider",
                    target: "compStyle.__root.initialValue"
                },
                {
                    displayName: "Final Value",
                    widget: "SLIDER",
                    widgetData: {
                        minValue: 0,
                        maxValue: 100,
                        stepCount: 1
                    },
                    grouping: "Range Slider",
                    target: "compStyle.__root.finalValue"
                }
            ],
            scope: "public"
        }
    ],
    functions: {
        customRender: function() {
            d3.select(__elId__slicerComp).selectAll("*").remove();

            let svg = d3.select(__elId__slicerComp),
                margin = {right: 0, left: 0},
                width = __var__compStyle.__root.width - margin.left - margin.right,
                height = __var__compStyle.__root.height;


            let x = d3.scaleLinear()
                .domain([0, 100])
                .range([0, width])
                .clamp(true);

            let slider = svg.append("g")
                .attr("class", "slider")
                .style("pointer-events", "none")
                .attr("transform", "translate(" + margin.left + "," + height / 2 + ")");

            slider.append("line")
                .attr("x1", x.range()[0])
                .attr("x2", x.range()[1])
                .style("stroke", __var__compStyle.__root.stroke)
                .style("stroke-width", __var__compStyle.__root.strokeWidth)
                .call(d3.drag()
                    .on("start.interrupt", function() { slider.interrupt(); })
                    .on("start drag", function() { hue(x.invert(d3.event.x)); }));

            slider.append("line")
                .attr("x1", x(__var__compStyle.__root.initialValue))
                .attr("x2", x(__var__compStyle.__root.finalValue))
                .style("stroke", __var__compStyle.__root.fill)
                .style("stroke-width", __var__compStyle.__root.strokeWidth);


            let handle = slider.insert("rect", ".track-overlay")
                .attr("class", "handle")
                .attr("width", __var__compStyle.__root.handleThickness)
                .attr("height", __var__compStyle.__root.height)
                .attr("y", -__var__compStyle.__root.height/2)
                .style("rx", 0)
                .style("ry", 0)
                .style("fill", __var__compStyle.__root.handleColor);

            let handle_2 = slider.insert("rect", ".track-overlay")
                .attr("class", "handle_2")
                .attr("width", __var__compStyle.__root.handleThickness )
                .attr("height", __var__compStyle.__root.height)
                .attr("y", -__var__compStyle.__root.height/2)
                .style("rx", 0)
                .style("ry", 0)
                .style("fill", __var__compStyle.__root.handleColor);


            slider.transition()
                .duration(750)
                .tween("hue", function() {
                    let i = d3.interpolate(__var__compStyle.__root.initialValue, __var__compStyle.__root.initialValue);
                    return function(t) { hue(i(t)); };
                })
                .tween("hue_2", function() {
                    let i = d3.interpolate(__var__compStyle.__root.finalValue, __var__compStyle.__root.finalValue);
                    return function(t) { hue_2(i(t)); };
                });

            let hue = function(h) {
                handle.attr("x", x(h));
            };

            let hue_2 = function(h) {
                handle_2.attr("x", x(h));
            };
        }
    },
    eventHandlers: [],
    eventEmitters: [],
    actions: [],
    workflows: {},
    localTemplates: {},
    structure: {
        type: "svg",
        id: "slicerComp",
        props: {
            width: "__var__compStyle.__root.width",
            height: "__var__compStyle.__root.height",
            style: {
                overflow: "visible"
            }
        },
        children: "__fn__customRender()"


    },
    lifecycleHooks: {
        init: {
            before: function() {

            },
            after: function() {
            }
        },
        onModelChange: function(newExternalVariables) {

        },
        reRender: {
            shouldAllow: function(newExternalVariables) {
                return true;
            },
            before: function(newExternalVariables) {

            },
            after: function(newExternalVariables) {
            }
        },
        cleanup: function() {

        }
    }

};